worker_processes auto;
events { worker_connections 1024; }
http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  keepalive_timeout 65;
  client_max_body_size 20m;

  server {
    # Render maps external traffic to $PORT (10000 by default)
    listen 10000 default_server;
    listen [::]:10000 default_server;

    # -------- Streamlit demo under /demo/app/ (WS support) --------
    location /demo/app/ {
      # NOTE: no trailing slash here so /demo/app/... is preserved upstream
      proxy_pass http://127.0.0.1:10002;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      # Allow embedding by stripping restrictive headers from upstream
      proxy_hide_header X-Frame-Options;
      proxy_hide_header Content-Security-Policy;
    }
    # Ensure /demo/app (no trailing slash) redirects correctly
    location = /demo/app { return 301 /demo/app/; }

    # -------- Serve the wrapper page /demo directly from static --------
    location = /demo {
      root /app/backend/static;
      try_files /demo/index.html =404;
      default_type text/html;
    }
    location = /trust { root /app/backend/static; try_files /trust/index.html =404; default_type text/html; }

    # -------- Everything else to FastAPI (Uvicorn) --------
    location / {
      proxy_pass http://127.0.0.1:10001;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    }
  }
}
